{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{% block content %}
<style>
    /* 1. Formaning o'zini va asosiy bloklarni kengaytirish */
    #content-main,
    #content-main form,
    .form-horizontal {
        width: 100% !important;
        max-width: 100% !important;
        display: block !important;
        flex: none !important;
    }

    /* 2. XML maydonni yashirish */
    .field-xml_data {
        display: none !important;
    }

    /* 3. Draw.io uchun maxsus "buzib chiquvchi" konteyner */
    #drawio-wrapper {
        display: block;
        width: 100% !important;
        margin-top: 20px;
        background: #fff;
        /* Agar tema padding bergan bo'lsa, uni ignor qilish uchun: */
        box-sizing: border-box;
    }

    /* Sarlavha qismi */
    .drawio-header {
        background: #417690; /* Django standarti */
        color: white;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: bold;
        text-transform: uppercase;
        border-radius: 4px 4px 0 0;
    }

    /* 4. Iframe konteyneri - eng muhim qismi */
    #drawio-container {
        width: 100% !important;
        height: 850px; /* Balandlikni yana sal oshirdik */
        border: 1px solid #ccc;
        background-color: white;
        /* Iframe to'liq sig'ishi uchun */
        display: flex;
        flex-direction: column;
    }

    iframe {
        flex: 1; /* Konteyner ichini to'liq egallaydi */
        width: 100% !important;
        height: 100% !important;
        border: none;
        display: block;
    }

    /* Maydonlar (Name, Active) chiroyli turishi uchun */
    fieldset.module {
        width: 100% !important;
        max-width: 100% !important;
        margin-bottom: 20px !important;
    }
</style>

<div id="content-main">
    <form {% if has_file_field %}enctype="multipart/form-data" {% endif %}action="{{ form_url }}" method="post" id="org_structure_form">
        {% csrf_token %}
        {% if is_popup %}<input type="hidden" name="{{ is_popup_var }}" value="1">{% endif %}
        {% if to_field %}<input type="hidden" name="{{ to_field_var }}" value="{{ to_field }}">{% endif %}

        {% if errors %}
            <p class="errornote">
            {% if errors|length == 1 %}{% translate "Please correct the error below." %}{% else %}{% translate "Please correct the errors below." %}{% endif %}
            </p>
            {{ adminform.form.non_field_errors }}
        {% endif %}

        <fieldset class="module aligned">
            <div class="form-row field-title">
                <div class="flex-container">
                    <label for="id_title" class="required">Nomi:</label>
                    {{ adminform.form.title }}
                </div>
            </div>
            <div class="form-row field-is_active">
                <div class="flex-container">
                    {{ adminform.form.is_active }}
                    <label for="id_is_active" class="vCheckboxLabel" style="display:inline; margin-left:5px;">Faol</label>
                </div>
            </div>
            <div class="form-row field-xml_data">
                {{ adminform.form.xml_data }}
            </div>
        </fieldset>

        <div id="drawio-wrapper">
            <div class="drawio-header">
                Tuzilma Diagrammasi (Builder)
            </div>
            <div id="drawio-container">
                <iframe id="drawio-iframe" src="https://embed.diagrams.net/?embed=1&ui=kennedy&spin=1&proto=json&libraries=1&noSaveBtn=1"></iframe>
            </div>
        </div>

        <div class="submit-row">
            <input type="submit" value="{% translate 'Save' %}" class="default" name="_save">
            <input type="submit" value="{% translate 'Save and continue editing' %}" name="_continue">
        </div>
    </form>
</div>

<script>
    (function() {
        var iframe = document.getElementById('drawio-iframe');
        var xmlInput = document.getElementById('id_xml_data');

        if (!xmlInput) return;

        var initialXml = xmlInput.value;

        window.addEventListener('message', function(event) {
            if (event.source !== iframe.contentWindow) return;

            var msg;
            try { msg = JSON.parse(event.data); } catch (e) { return; }

            if (msg.event == 'init') {
                iframe.contentWindow.postMessage(JSON.stringify({
                    action: 'load',
                    xml: initialXml,
                    autosave: 1
                }), '*');
            }
            else if (msg.event == 'save' || msg.event == 'autosave') {
                if (msg.xml) {
                    xmlInput.value = msg.xml;
                }
            }
        });
    })();
</script>
{% endblock %}