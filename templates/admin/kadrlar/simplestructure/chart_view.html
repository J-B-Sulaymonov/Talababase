{% extends "admin/base_site.html" %}
{% load mptt_tags static %}

{% block extrahead %}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>

    <style>
        /* =========================================
           1. GLOBAL SOZLAMALAR
           ========================================= */
        :root {
            --line-color: #94a3b8;
            --line-width: 2px;
            --gap-y: 50px;
            --gap-x: 20px;
            --node-width: 220px;

            /* Qog'oz o'lchamlari (Default A4 Landscape px da) */
            /* 1mm â‰ˆ 3.7795px */
            --paper-width: 1122.5px;  /* 297mm */
            --paper-height: 793.7px;  /* 210mm */
        }

        .custom-chart-wrapper * { box-sizing: border-box; }

        .custom-chart-wrapper {
            font-family: 'Inter', sans-serif;
            background-color: #525659; /* To'q kulrang fon */
            height: calc(100vh - 60px);
            width: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Orqaga tugmasi */
        .btn-back {
            position: absolute; left: 20px; top: 20px; z-index: 2000;
            background-color: rgba(30, 41, 59, 0.8); color: #fff !important;
            padding: 8px 16px; border-radius: 6px; text-decoration: none !important;
            display: flex; align-items: center; gap: 8px; font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(4px);
            transition: all 0.2s;
        }
        .btn-back:hover { background-color: #0f172a; transform: translateY(-2px); }

        /* =========================================
           2. VIRTUAL QOG'OZ (CANVAS)
           ========================================= */
        /* Panzoom sahnasi */
        #panzoom-scene {
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            /* Padding kamaytirildi, qog'oz ekranga yaqinroq bo'lishi uchun */
            padding: 20px;
        }

        /* OQ QOG'OZ */
        #virtual-paper {
            background-color: white;
            width: var(--paper-width);
            height: var(--paper-height);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
            transition: width 0.4s ease, height 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Chizma Konteneri (Qog'oz ichida) */
        #chart-inner-container {
            transform-origin: center center;
            transition: transform 0.4s ease;
            position: relative;
            display: flex;
            justify-content: center;
        }

        /* =========================================
           3. DARAXT (TREE) STYLES
           ========================================= */
        .tree { display: inline-flex; justify-content: center; }

        .tree ul {
            padding-top: var(--gap-y); position: relative;
            display: flex; justify-content: center;
            margin: 0; padding-left: 0; gap: var(--gap-x);
        }

        .tree li {
            text-align: center; list-style-type: none; position: relative;
            padding: var(--gap-y) 10px 0 10px;
        }

        /* CSS Chiziqlar */
        .tree li::before, .tree li::after {
            content: ''; position: absolute; top: 0; right: 50%;
            width: 50%; height: var(--gap-y);
            border-top: var(--line-width) solid var(--line-color);
            z-index: 0;
        }
        .tree li::after { right: auto; left: 50%; border-left: var(--line-width) solid var(--line-color); }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: var(--line-width) solid var(--line-color); border-radius: 0 15px 0 0; }
        .tree li:first-child::after { border-radius: 15px 0 0 0; }
        .tree ul ul::before {
            content: ''; position: absolute; top: 0; left: 50%;
            border-left: var(--line-width) solid var(--line-color);
            width: 0; height: var(--gap-y);
        }

        /* SVG Mode uchun CSS chiziqlarni o'chirish */
        .tree ul.hide-css-lines > li::before,
        .tree ul.hide-css-lines > li::after,
        .tree ul.hide-css-lines::before { display: none !important; }

        .tree li.is-leaf-node::before, .tree li.is-leaf-node::after { display: none !important; }
        .tree li.is-leaf-node { padding-top: 0 !important; }

        /* Karta dizayni */
        .node-card {
            background: #fff; border: 1px solid #cbd5e1;
            padding: 10px; width: var(--node-width); min-height: 55px;
            display: inline-flex; justify-content: center; align-items: center;
            border-radius: 6px; font-weight: 700; font-size: 11px; text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 10;
            position: relative; cursor: pointer; user-select: none;
            transition: all 0.2s;
        }
        .node-card:hover {
            border-color: #3b82f6; background: #eff6ff; color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.2);
        }
        .count-badge {
            position: absolute; top: -8px; right: -8px;
            background: #ef4444; color: #fff; border-radius: 50%;
            width: 20px; height: 20px; font-size: 10px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
        }

        /* Guruhlar */
        .side-group-li {
            display: flex; flex-direction: column; align-items: center;
            padding-top: var(--gap-y); min-width: 240px;
        }
        .side-stack { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .group-left .side-stack { align-items: flex-end; padding-right: 30px; }
        .group-right .side-stack { align-items: flex-start; padding-left: 30px; }

        /* SVG */
        .connector-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; overflow: visible;
        }
        .svg-line {
            fill: none; stroke: #94a3b8; stroke-width: 2px;
            stroke-linejoin: round; stroke-linecap: round;
        }

        /* =========================================
           4. TOOLBAR & CONTROLS
           ========================================= */
        .paper-controls {
            position: absolute; top: 20px; right: 20px; z-index: 2000;
            background: white; padding: 10px 15px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; gap: 15px; align-items: center;
        }

        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-group label { font-size: 9px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        .control-select {
            padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 6px;
            font-size: 13px; outline: none; background: #f8fafc; color: #334155; font-weight: 500;
            cursor: pointer;
        }
        .control-select:hover { border-color: #cbd5e1; }

        .zoom-controls {
            position: absolute; bottom: 30px; right: 30px; z-index: 2000;
            background: white; padding: 8px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: flex; gap: 5px;
        }
        .icon-btn {
            width: 40px; height: 40px; border: none; background: #f1f5f9; border-radius: 8px;
            cursor: pointer; color: #475569; font-size: 16px; transition: 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: #e2e8f0; color: #0f172a; transform: scale(1.05); }

        /* =========================================
           5. MODAL & CARDS
           ========================================= */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(8px);
            z-index: 9999; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.show { opacity: 1; }

        .modal-window {
            background: #ffffff;
            width: 480px; max-width: 90%;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.show .modal-window { transform: scale(1); }

        .modal-header {
            padding: 20px 25px; background: #ffffff;
            border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 18px; font-weight: 800; color: #1e293b; letter-spacing: -0.5px; }

        .close-btn {
            background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 50%;
            color: #64748b; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .close-btn:hover { background: #fee2e2; color: #ef4444; transform: rotate(90deg); }

        .modal-body { padding: 15px; overflow-y: auto; max-height: 60vh; background-color: #f8fafc; }

        /* XODIM KARTASI */
        .employee-link { text-decoration: none; color: inherit; display: block; }

        .employee-item {
            background: white; padding: 12px 15px; margin-bottom: 10px;
            border-radius: 12px; border: 1px solid #e2e8f0;
            display: flex; align-items: center; gap: 15px;
            transition: all 0.2s ease; position: relative; cursor: pointer;
        }
        .employee-item:hover {
            border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .emp-avatar {
            width: 50px; height: 50px; border-radius: 50%; object-fit: cover;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .emp-info { flex: 1; text-align: left; }
        .emp-name { font-size: 15px; font-weight: 700; color: #0f172a; margin-bottom: 2px; }
        .emp-pos { font-size: 12px; color: #64748b; font-weight: 500; line-height: 1.4; }
        .emp-degree {
            display: inline-block; margin-top: 4px; font-size: 10px; font-weight: 700;
            text-transform: uppercase; padding: 2px 8px; border-radius: 10px;
            background: #eff6ff; color: #3b82f6;
        }
        .go-icon { color: #cbd5e1; font-size: 14px; transition: 0.2s; }
        .employee-item:hover .go-icon { color: #3b82f6; transform: translateX(3px); }

    </style>
{% endblock %}

{% block content %}

<div class="custom-chart-wrapper">
    <a href="../" class="btn-back"><i class="fas fa-arrow-left"></i> Chiqish</a>

    <div class="paper-controls">
        <div class="control-group">
            <label>Format</label>
            <select id="pageSize" class="control-select" onchange="updatePaper()">
                <option value="a4">A4</option>
                <option value="a3">A3</option>
            </select>
        </div>
        <div class="control-group">
            <label>Orientatsiya</label>
            <select id="pageOrientation" class="control-select" onchange="updatePaper()">
                <option value="l">Albom (Landscape)</option>
                <option value="p">Knijniy (Portrait)</option>
            </select>
        </div>
        </div>

    <div id="panzoom-scene">
        <div id="virtual-paper">
            <div id="chart-inner-container">
                <div class="tree-container">
                    <div class="tree">
                        <ul>
                            {% recursetree nodes %}
                                <li class="tree-node-li" id="node-li-{{ node.id }}" data-type="{{ node.node_type }}">
                                    <div class="node-card" id="card-{{ node.id }}" onclick="openModal('{{ node.id }}', '{{ node.name|escapejs }}')">
                                        {{ node.name }}
                                        {% with c=node.get_employee_count %}
                                            {% if c > 0 %}<span class="count-badge">{{ c }}</span>{% endif %}
                                        {% endwith %}
                                    </div>
                                    {% if not node.is_leaf_node %}
                                        <ul class="level-ul">
                                            {{ children }}
                                        </ul>
                                    {% endif %}
                                </li>
                            {% endrecursetree %}
                        </ul>
                    </div>
                    <svg class="connector-svg" id="mainSvg"></svg>
                </div>
            </div>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="icon-btn" id="btnZoomOut" title="Kichraytirish"><i class="fas fa-minus"></i></button>
        <button class="icon-btn" id="btnReset" title="Moslash (Reset)"><i class="fas fa-compress"></i></button>
        <button class="icon-btn" id="btnZoomIn" title="Kattalashtirish"><i class="fas fa-plus"></i></button>
    </div>
</div>

<div class="modal-overlay" id="employeeModal" onclick="if(event.target.id==='employeeModal') closeModal()">
    <div class="modal-window">
        <div class="modal-header">
            <span class="modal-title" id="modalTitle">Bo'lim xodimlari</span>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalContent">
        </div>
    </div>
</div>

<script>
    let panzoomInstance = null;
    const MM_TO_PX = 3.7795;
    const SIZES = {
        'a4': { w: 297, h: 210 },
        'a3': { w: 420, h: 297 }
    };

    document.addEventListener("DOMContentLoaded", function() {
        setTimeout(() => {
            initTree();
            drawLines();
            initPanzoom();
            updatePaper();
        }, 100);

        window.addEventListener('resize', () => {
            drawLines();
            fitContentToPaper();
            fitPaperToScreen(); // Ekran o'zgarganda qog'ozni ham moslash
        });
    });

    // ===============================================
    // 1. QOG'OZ VA SIG'DIRISH MANTIQI
    // ===============================================
    function updatePaper() {
        const sizeKey = document.getElementById('pageSize').value;
        const orient = document.getElementById('pageOrientation').value;
        const paper = document.getElementById('virtual-paper');

        let mmW = SIZES[sizeKey].w;
        let mmH = SIZES[sizeKey].h;

        if (orient === 'p') { [mmW, mmH] = [mmH, mmW]; }

        const pxW = mmW * MM_TO_PX;
        const pxH = mmH * MM_TO_PX;

        paper.style.width = `${pxW}px`;
        paper.style.height = `${pxH}px`;

        // 1. Avval kontentni qog'ozga sig'diramiz
        setTimeout(() => {
            fitContentToPaper();
            // 2. Keyin qog'ozni ekranga sig'diramiz (bo'sh joyni yo'qotish uchun)
            fitPaperToScreen();
        }, 300);
    }

    function fitContentToPaper() {
        // Bu funksiya daraxtni A4/A3 qog'oz ichiga sig'diradi
        const paper = document.getElementById('virtual-paper');
        const content = document.getElementById('chart-inner-container');

        const paperW = paper.clientWidth;
        const paperH = paper.clientHeight;

        content.style.transform = 'scale(1)';
        const contentW = content.scrollWidth;
        const contentH = content.scrollHeight;

        const padding = 50;
        const availW = paperW - (padding * 2);
        const availH = paperH - (padding * 2);

        const scaleX = availW / contentW;
        const scaleY = availH / contentH;

        let scale = Math.min(scaleX, scaleY);
        if (scale > 1) scale = 1;

        content.style.transform = `scale(${scale})`;
        content.style.transformOrigin = 'center center';
    }

    // --- YANGI: QOG'OZNI EKRANGA MOSLASH (MAX ZOOM) ---
    function fitPaperToScreen() {
        if (!panzoomInstance) return;

        const container = document.querySelector('.custom-chart-wrapper');
        const paper = document.getElementById('virtual-paper');

        const containerW = container.clientWidth;
        const containerH = container.clientHeight;
        const paperW = paper.clientWidth;
        const paperH = paper.clientHeight;

        // Ekran va qog'oz orasidagi nisbatni topamiz
        // 20px padding ajratamiz (har tomondan 10px dan)
        const padding = 20;
        const scaleX = (containerW - padding) / paperW;
        const scaleY = (containerH - padding) / paperH;

        // Qog'oz ekranga to'liq sig'ishi uchun eng kichik nisbatni olamiz
        // Lekin juda kattalashib ketmasligi uchun (maxScale) bilan cheklaymiz
        let newScale = Math.min(scaleX, scaleY);

        // Ekranni to'ldirish uchun Zoom qilamiz
        panzoomInstance.zoom(newScale);

        // Markazga joylashtiramiz
        setTimeout(() => panzoomInstance.pan(0, 0), 50);
    }

    // ===============================================
    // 2. ZOOM (PANZOOM)
    // ===============================================
    function initPanzoom() {
        const elem = document.getElementById('panzoom-scene');

        // startScale endi muhim emas, chunki fitPaperToScreen() uni qayta hisoblaydi
        panzoomInstance = Panzoom(elem, {
            maxScale: 10, minScale: 0.05, startScale: 0.5,
            cursor: 'grab', contain: false
        });

        elem.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);

        document.getElementById('btnZoomIn').addEventListener('click', panzoomInstance.zoomIn);
        document.getElementById('btnZoomOut').addEventListener('click', panzoomInstance.zoomOut);
        document.getElementById('btnReset').addEventListener('click', () => {
            fitPaperToScreen(); // Reset bosilganda ham ekranga moslashtiramiz
        });
    }

    // ===============================================
    // 3. DARAXT (LOGIKA)
    // ===============================================
    function initTree() {
        document.querySelectorAll('.tree li').forEach(li => {
            if (!li.querySelector('ul') || li.querySelector('ul').children.length === 0)
                li.classList.add('is-leaf-node');
        });

        document.querySelectorAll('.tree ul').forEach(ul => {
            if (ul.classList.contains('vertical-layout')) return;
            let children = Array.from(ul.children);
            let leftNodes = [], rightNodes = [];
            children.forEach(li => {
                let type = li.getAttribute('data-type');
                if (type === 'staff_left') leftNodes.push(li);
                else if (type === 'staff_right') rightNodes.push(li);
            });

            if (leftNodes.length > 0 || rightNodes.length > 0) {
                ul.classList.add('hide-css-lines');
                if (leftNodes.length > 0) createSideGroup(ul, leftNodes, 'left', true);
                if (rightNodes.length > 0) createSideGroup(ul, rightNodes, 'right', false);
            }
        });
    }

    function createSideGroup(parentUl, nodes, side, isPrepend) {
        let groupLi = document.createElement('li');
        groupLi.className = `side-group-li group-${side}`;
        let stackDiv = document.createElement('div');
        stackDiv.className = `side-stack`;
        nodes.forEach(oldLi => {
            let card = oldLi.querySelector('.node-card');
            if(card) { card.style.marginBottom = "0"; stackDiv.appendChild(card); }
            oldLi.remove();
        });
        groupLi.appendChild(stackDiv);
        isPrepend ? parentUl.prepend(groupLi) : parentUl.append(groupLi);
    }

    // ===============================================
    // 4. SVG CHIZIQLAR
    // ===============================================
    function drawLines() {
        const svg = document.getElementById('mainSvg');
        svg.innerHTML = '';
        const container = document.querySelector('.tree-container');

        function getPos(el) {
            if (!el) return {x:0, y:0, w:0, h:0};
            const r = el.getBoundingClientRect();
            const c = container.getBoundingClientRect();

            const style = window.getComputedStyle(document.getElementById('chart-inner-container'));
            const matrix = new WebKitCSSMatrix(style.webkitTransform);
            const currentScale = matrix.a || 1;

            return {
                x: (r.left - c.left) / currentScale,
                y: (r.top - c.top) / currentScale,
                w: r.width / currentScale,
                h: r.height / currentScale
            };
        }

        function createPath(d) {
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", d); path.setAttribute("class", "svg-line");
            svg.appendChild(path);
        }

        document.querySelectorAll('.tree ul.hide-css-lines').forEach(ul => {
            const parentLi = ul.closest('li');
            if (!parentLi) return;
            const parentCard = parentLi.querySelector('.node-card');

            const p = getPos(parentCard);
            const startX = p.x + p.w / 2;
            const startY = p.y + p.h;
            const bridgeY = startY + 30;

            let children = Array.from(ul.children);
            let minX = Infinity, maxX = -Infinity;
            let targets = [];

            children.forEach(li => {
                if (li.classList.contains('side-group-li')) {
                    const stack = li.querySelector('.side-stack');
                    const cards = stack.querySelectorAll('.node-card');
                    if(cards.length===0) return;
                    const isLeft = li.classList.contains('group-left');
                    const firstCard = cards[0];
                    const fc = getPos(firstCard);
                    const connectX = isLeft ? (fc.x + fc.w) : fc.x;
                    const spineX = connectX + (isLeft ? 20 : -20);
                    if (spineX < minX) minX = spineX;
                    if (spineX > maxX) maxX = spineX;
                    targets.push({ type: 'group', spineX, bridgeY, cards, isLeft });
                } else {
                    const card = li.querySelector('.node-card');
                    if(!card) return;
                    const c = getPos(card);
                    const cx = c.x + c.w / 2;
                    if (cx < minX) minX = cx;
                    if (cx > maxX) maxX = cx;
                    targets.push({ type: 'normal', x: cx, y: c.y });
                }
            });

            createPath(`M ${startX} ${startY} L ${startX} ${bridgeY}`);
            if (minX !== Infinity && maxX !== -Infinity) createPath(`M ${minX} ${bridgeY} L ${maxX} ${bridgeY}`);

            targets.forEach(t => {
                if(t.type === 'normal') createPath(`M ${t.x} ${bridgeY} L ${t.x} ${t.y}`);
                else {
                    const lastCard = t.cards[t.cards.length - 1];
                    const lc = getPos(lastCard);
                    createPath(`M ${t.spineX} ${bridgeY} L ${t.spineX} ${lc.y + lc.h/2}`);
                    t.cards.forEach(card => {
                        const c = getPos(card);
                        const edgeX = t.isLeft ? (c.x + c.w) : c.x;
                        createPath(`M ${t.spineX} ${c.y + c.h/2} L ${edgeX} ${c.y + c.h/2}`);
                    });
                }
            });
        });
    }

    // ===============================================
    // 5. MODAL & CLICKABLE CARDS
    // ===============================================
    function openModal(nodeId, nodeName) {
        const modal = document.getElementById('employeeModal');
        const content = document.getElementById('modalContent');
        const title = document.getElementById('modalTitle');

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);

        title.innerText = nodeName;
        content.innerHTML = `<div style="text-align:center; padding:30px;"><i class="fas fa-spinner fa-spin" style="font-size:24px; color:#3b82f6;"></i></div>`;

        fetch(`../api-node-details/${nodeId}/`)
            .then(res => res.json())
            .then(data => {
                if (!data.employees || data.employees.length === 0) {
                    content.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8;"><i class="fas fa-users-slash" style="font-size:32px; margin-bottom:10px;"></i><br>Xodimlar biriktirilmagan</div>`;
                    return;
                }

                let html = '';
                data.employees.forEach(emp => {
                    let avatarUrl = emp.photo ? emp.photo : `https://ui-avatars.com/api/?name=${encodeURIComponent(emp.full_name)}&background=random`;
                    let link = emp.id ? `../../employee/${emp.id}/card/` : '#';

                    html += `
                    <a href="${link}" target="_blank" class="employee-link" title="ID Kartani ko'rish">
                        <div class="employee-item">
                            <img src="${avatarUrl}" class="emp-avatar">
                            <div class="emp-info">
                                <div class="emp-name">${emp.full_name}</div>
                                <div class="emp-pos">${emp.position}</div>
                                ${emp.degree && emp.degree !== "Yo'q" ? `<div class="emp-degree">${emp.degree}</div>` : ''}
                            </div>
                            <i class="fas fa-chevron-right go-icon"></i>
                        </div>
                    </a>`;
                });
                content.innerHTML = html;
            })
            .catch(e => {
                content.innerHTML = '<div style="color:red; text-align:center; padding:20px;">Xatolik!</div>';
            });
    }

    function closeModal() {
        const modal = document.getElementById('employeeModal');
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    }
</script>
{% endblock %}