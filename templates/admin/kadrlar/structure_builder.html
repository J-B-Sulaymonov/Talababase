{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jerosoler/Drawflow/dist/drawflow.min.js"></script>

    <style>
        :root {
            --df-bg-color: #ffffff; /* Qog'oz rangi oq */
            --df-grid-color: #f1f5f9;
            --workspace-bg: #e2e8f0; /* Orqa fon kulrang */
            --primary-color: #3b82f6;
            --port-size: 14px;
        }

        body { font-family: 'Inter', sans-serif !important; overflow: hidden; background: #f8fafc; }

        /* --- TOOLBAR --- */
        .toolbar-container {
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
            background: white; padding: 10px 15px; border-radius: 12px;
            margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid #cbd5e1;
        }

        .toolbar-group {
            display: flex; gap: 5px; align-items: center;
            border-right: 1px solid #cbd5e1; padding-right: 10px; margin-right: 5px;
        }
        .toolbar-group:last-child { border-right: none; }

        .btn-icon {
            background: white; border: 1px solid #cbd5e1; color: #334155;
            width: 34px; height: 34px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; font-size: 14px;
        }
        .btn-icon:hover { background: #f1f5f9; color: #3b82f6; border-color: #3b82f6; }
        .btn-icon.active { background: #eff6ff; color: #3b82f6; border-color: #3b82f6; font-weight: bold; }

        .input-control {
            padding: 0 10px; height: 34px; border: 1px solid #cbd5e1; border-radius: 6px;
            font-size: 13px; outline: none; transition: 0.2s; background: white;
        }
        .input-control:focus { border-color: #3b82f6; }

        /* --- WORKSPACE (QOG'OZ MAYDONI) --- */
        .workspace-wrapper {
            background-color: var(--workspace-bg);
            height: 78vh;
            border-radius: 12px;
            overflow: auto; /* Scroll bo'lishi uchun */
            display: flex;
            justify-content: center; /* Qog'ozni o'rtaga olish */
            padding: 40px; /* Qog'oz atrofida bo'sh joy */
            border: 1px solid #cbd5e1;
            position: relative;
        }

        #drawflow {
            position: relative;
            background-color: var(--df-bg-color);
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: width 0.3s ease, height 0.3s ease; /* O'lcham o'zgarganda animatsiya */
            outline: none;
        }

        /* Qog'oz o'lchamlari */
        .paper-a4-landscape { width: 1123px; height: 794px; }
        .paper-a4-portrait  { width: 794px; height: 1123px; }
        .paper-a3-landscape { width: 1587px; height: 1123px; }
        .paper-a3-portrait  { width: 1123px; height: 1587px; }

        /* --- ZAMONAVIY PORTLAR VA BOG'LASH (YANGILANGAN) --- */

        /* 1. Tugun (Node) sozlamalari */
        .drawflow .drawflow-node {
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            width: auto !important;
            min-width: 200px;
            position: absolute !important;
            z-index: 2;
        }

        /* 2. Portlarning umumiy ko'rinishi (Input va Output bitta dizaynda) */
        .drawflow .drawflow-node .input,
        .drawflow .drawflow-node .output {
            width: 14px !important;
            height: 14px !important;
            background: #ffffff !important;     /* Ichki qismi oq */
            border: 2px solid #94a3b8 !important; /* Cheti kulrang */
            border-radius: 50%;
            position: absolute !important;
            z-index: 100;
            cursor: crosshair;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* Markazlashtirish uchun transform */
            transform: translate(-50%, -50%);
        }

        /* Hover bo'lganda port rangi o'zgaradi */
        .drawflow .drawflow-node:hover .input,
        .drawflow .drawflow-node:hover .output {
            border-color: var(--primary-color) !important;
            background: #eff6ff !important;
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Port ustiga sichqoncha borganda "aktiv" holat */
        .drawflow .drawflow-node .input:hover,
        .drawflow .drawflow-node .output:hover {
            background: var(--primary-color) !important;
            border-color: white !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); /* "Halo" effekti */
            transform: translate(-50%, -50%) scale(1.4) !important;
        }

        /* 3. 4-TOMONLAMA JOYLASHTIRISH (Ustma-ust tushirish) */

        /* TOP (Tepa) - Input 1 & Output 1 */
        .drawflow-node .input_1, .drawflow-node .output_1 {
            top: 0px !important;
            left: 50% !important;
        }

        /* RIGHT (O'ng) - Input 2 & Output 2 */
        .drawflow-node .input_2, .drawflow-node .output_2 {
            top: 50% !important;
            left: 100% !important; /* O'ng chet */
        }

        /* BOTTOM (Past) - Input 3 & Output 3 */
        .drawflow-node .input_3, .drawflow-node .output_3 {
            top: 100% !important; /* Pastki chet */
            left: 50% !important;
        }

        /* LEFT (Chap) - Input 4 & Output 4 */
        .drawflow-node .input_4, .drawflow-node .output_4 {
            top: 50% !important;
            left: 0px !important;
        }

        /* 4. CHIZIQLAR DIZAYNI (CONNECTIONS) */

        /* Tayyor bo'lgan bog'lam (Mustahkam o'tkir rang) */
        .drawflow .connection .main-path {
            stroke-width: 3px;
            stroke: #2563eb; /* To'q ko'k */
            fill: none;
            transition: stroke-width 0.2s, stroke 0.2s;
        }

        /* Bog'lam ustiga borganda */
        .drawflow .connection:hover .main-path {
            stroke: #f59e0b; /* Sariq/Olovrang */
            stroke-width: 4px;
            cursor: pointer;
        }

        /* Tanlangan bog'lam */
        .drawflow .connection.selected .main-path {
            stroke: #dc2626; /* Qizil */
            stroke-width: 4px;
        }

        /* --- SIDEBAR --- */
        [contenteditable="true"] { outline: none; }
        .sidebar-item { padding: 10px; margin-bottom: 5px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 12px; cursor: grab; font-weight: 500; display: flex; align-items: center; gap: 8px;}
        .sidebar-item:hover { border-color: #3b82f6; color: #3b82f6; }
        .dept-header { cursor: pointer; padding: 10px; background: white; margin-bottom: 5px; border-radius: 6px; font-weight: 600; font-size: 13px; border: 1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;}
        .employee-list { display: none; padding-left: 10px; margin-bottom: 10px; border-left: 2px solid #e2e8f0; margin-left:10px; }

        .btn-primary { background: #10b981; color: white; border: none; padding: 0 20px; font-weight: 600; height: 34px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;}
        .btn-primary:hover { background: #059669; }
    </style>
{% endblock %}

{% block content %}
<div style="padding: 20px;">

    <div class="toolbar-container">
        <div class="toolbar-group">
            <h2 style="margin: 0 10px 0 0; font-size: 18px; color: #0f172a;">
                <i class="fas fa-project-diagram" style="color: #3b82f6;"></i>
            </h2>
            <input type="text" id="struct_title" value="{{ original.title|default:'' }}" placeholder="Struktura nomi..." class="input-control" style="width: 160px; font-weight: 700;">
        </div>

        <div class="toolbar-group" style="background: #f8fafc; padding: 0 8px; border-radius: 6px;">
            <span style="font-size: 11px; font-weight: 700; color: #64748b; margin-right: 5px;">FORMAT:</span>
            <select id="paperFormat" onchange="updatePaperSize()" class="input-control" style="width: 60px; cursor: pointer;">
                <option value="a4" selected>A4</option>
                <option value="a3">A3</option>
            </select>
            <select id="paperOrientation" onchange="updatePaperSize()" class="input-control" style="width: 130px; cursor: pointer;">
                <option value="landscape" selected>Albom (Yotiq)</option>
                <option value="portrait">Kitob (Tik)</option>
            </select>
        </div>

        <div class="toolbar-group">
            <select id="template_style" onchange="applyGlobalSettings()" class="input-control">
                <option value="simple" {% if original.template_style == 'simple' %}selected{% endif %}>Oddiy (Oq-Qora)</option>
                <option value="corporate" {% if original.template_style == 'corporate' %}selected{% endif %}>Korporativ (Gradient)</option>
                <option value="hierarchy" {% if original.template_style == 'hierarchy' %}selected{% endif %}>Ierarxiya (Minimal)</option>
            </select>
        </div>

        <div class="toolbar-group">
            <button class="btn-icon" onclick="setGlobalProp('textCase', 'uppercase')" title="Barchasi KATTA"><i class="fas fa-font" style="text-transform: uppercase;"></i></button>
            <button class="btn-icon" onclick="setGlobalProp('textCase', 'capitalize')" title="Bosh harf katta">Aa</button>
            <button class="btn-icon" onclick="setGlobalProp('textCase', 'lowercase')" title="kichik harflar">aa</button>
        </div>

        <div class="toolbar-group">
            <button class="btn-icon" onclick="setGlobalProp('textAlign', 'left')" title="Chapga"><i class="fas fa-align-left"></i></button>
            <button class="btn-icon" onclick="setGlobalProp('textAlign', 'center')" title="O'rtaga"><i class="fas fa-align-center"></i></button>
            <button class="btn-icon" onclick="setGlobalProp('textAlign', 'right')" title="O'ngga"><i class="fas fa-align-right"></i></button>
        </div>

        <div class="toolbar-group">
            <button class="btn-icon" id="btn-bold" onclick="toggleGlobalBool('isBold')" title="Qalin (Bold)"><i class="fas fa-bold"></i></button>
            <button class="btn-icon" id="btn-italic" onclick="toggleGlobalBool('isItalic')" title="Qiyshiq (Italic)"><i class="fas fa-italic"></i></button>
        </div>

        <div class="toolbar-group">
            <input type="color" id="textColorPicker" onchange="setGlobalProp('color', this.value)" value="#000000" style="width:34px; height:34px; border:none; cursor:pointer; background: transparent; padding: 0;" title="Matn rangi">
            <button class="btn-icon" onclick="changeFontSize(1)"><i class="fas fa-plus"></i></button>
            <button class="btn-icon" onclick="changeFontSize(-1)"><i class="fas fa-minus"></i></button>
        </div>

        <div style="margin-left: auto; display: flex; gap: 8px;">
            <button onclick="zoomReset()" class="btn-icon" title="Qog'ozni to'liq ko'rish"><i class="fas fa-expand"></i></button>
            <button onclick="exportFile()" class="btn-icon" style="width: auto; padding: 0 12px; gap: 6px; color: #dc2626; border-color: #fecaca; background: #fef2f2;"><i class="fas fa-file-pdf"></i> PDF</button>
            <button onclick="saveData()" class="btn-primary"><i class="fas fa-save"></i> Saqlash</button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 260px 1fr; gap: 20px; height: 78vh;">

        <div style="overflow-y: auto; padding-right: 5px; background: white; padding: 15px; border-radius: 12px; border: 1px solid #cbd5e1; height: 100%;">
            <div style="font-size: 11px; color: #94a3b8; font-weight: 800; margin-bottom: 10px;">ASOSIY BLOKLAR</div>

            <div draggable="true" ondragstart="drag(event)" data-node-type="title_only" data-node-name="YANGI BO'LIM" class="sidebar-item" style="border-left: 3px solid #0f172a;">
                <i class="fas fa-plus-square" style="color: #0f172a;"></i> YANGI BO'LIM
            </div>

            <div style="font-size: 11px; color: #94a3b8; font-weight: 800; margin: 20px 0 10px 0;">KAFEDRA VA BO'LIMLAR</div>

            {% for dept in db_departments_list %}
            <div>
                <div class="dept-header" onclick="toggleEmployees('list-{{ dept.id }}', this)">
                    <span><i class="fas fa-folder" style="color:#3b82f6; margin-right:5px;"></i> {{ dept.name }}</span>
                    <i class="fas fa-chevron-down" style="font-size: 10px; color: #94a3b8;"></i>
                </div>
                <div id="list-{{ dept.id }}" class="employee-list">
                    <div draggable="true" ondragstart="drag(event)" data-node-type="title_only" data-node-name="{{ dept.name }}" class="sidebar-item" style="font-weight: 700; color: #3b82f6;">
                        <i class="fas fa-layer-group"></i> {{ dept.name }} (Guruh)
                    </div>
                    {% for emp in dept.employees.all %}
                        {% if not emp.archived %}
                        <div draggable="true" ondragstart="drag(event)" data-node-type="full_info"
                             data-node-name="{{ emp.last_name }} {{ emp.first_name }}"
                             data-node-pos="{{ emp.positions.all.0.name|default:'Xodim' }}"
                             class="sidebar-item">
                            <i class="far fa-user"></i> {{ emp.last_name }} {{ emp.first_name }}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="workspace-wrapper">
            <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
        </div>
    </div>
</div>

<script>
    var container = document.getElementById("drawflow");
    var editor = new Drawflow(container);

    // --- DRAWFLOW SETUP (YANGILANGAN) ---
    editor.reroute = true;
    editor.reroute_fix_curvature = true;
    editor.force_first_input = false;  // Istalgan portga ulash uchun
    editor.line_path = 1;
    editor.curvature = 0.5;            // Chiziqlar silliq bo'lishi uchun
    editor.editor_mode = 'edit';
    editor.zoom_max = 2;
    editor.zoom_min = 0.3;

    // Bog'lash jarayonidagi vizual effektlar
    editor.on('connectionStart', function(info) {
        container.style.cursor = "grabbing";
    });

    editor.on('connectionCreated', function(info) {
        container.style.cursor = "default";
        console.log("Bog'landi: " + info.output_id + " -> " + info.input_id);
    });

    editor.start();

    // --- GLOBAL SOZLAMALAR ---
    let globalSettings = {
        textCase: 'uppercase',
        textAlign: 'center',
        isBold: true,
        isItalic: false,
        color: '#000000',
        fontSize: 14,
        paperFormat: 'a4',
        paperOrientation: 'landscape'
    };

    // --- PAPIER O'LCHAMLARI (PIXEL) ---
    const PAPER_SIZES = {
        'a4': { w: 1123, h: 794 },
        'a3': { w: 1587, h: 1123 }
    };

    // Data Import
    try {
        const savedData = {{ original.structure_data|safe }};
        if (savedData && savedData.drawflow) {
            if(savedData.globalSettings) {
                globalSettings = {...globalSettings, ...savedData.globalSettings};
                document.getElementById('textColorPicker').value = globalSettings.color || '#000000';
                document.getElementById('paperFormat').value = globalSettings.paperFormat || 'a4';
                document.getElementById('paperOrientation').value = globalSettings.paperOrientation || 'landscape';
            }
            editor.import(savedData);
            setTimeout(() => {
                applyGlobalSettings();
                updatePaperSize();
            }, 100);
        } else {
            updatePaperSize();
        }
    } catch (e) { updatePaperSize(); }

    // --- QOG'OZ O'LCHAMINI BOSHQARISH ---
    function updatePaperSize() {
        const format = document.getElementById('paperFormat').value;
        const orientation = document.getElementById('paperOrientation').value;

        globalSettings.paperFormat = format;
        globalSettings.paperOrientation = orientation;

        let width = PAPER_SIZES[format].w;
        let height = PAPER_SIZES[format].h;

        if (orientation === 'portrait') {
            let temp = width; width = height; height = temp;
        }

        container.style.width = width + 'px';
        container.style.height = height + 'px';
    }

    // --- GLOBAL SETTINGS FUNCTIONS ---
    function setGlobalProp(prop, value) {
        globalSettings[prop] = value;
        applyGlobalSettings();
        updateToolbarUI();
    }

    function toggleGlobalBool(prop) {
        globalSettings[prop] = !globalSettings[prop];
        applyGlobalSettings();
        updateToolbarUI();
    }

    function changeFontSize(delta) {
        globalSettings.fontSize += delta;
        if(globalSettings.fontSize < 8) globalSettings.fontSize = 8;
        if(globalSettings.fontSize > 40) globalSettings.fontSize = 40;
        applyGlobalSettings();
    }

    function updateToolbarUI() {
        document.getElementById('btn-bold').classList.toggle('active', globalSettings.isBold);
        document.getElementById('btn-italic').classList.toggle('active', globalSettings.isItalic);
    }

    function zoomReset() {
        editor.zoom_reset();
    }

    // --- HTML GENERATOR ---
    function generateNodeHTML(nodeType, title, empName, pos, styleName) {
        const gs = globalSettings;

        let textStyle = `
            text-transform: ${gs.textCase};
            text-align: ${gs.textAlign};
            font-weight: ${gs.isBold ? '800' : '400'};
            font-style: ${gs.isItalic ? 'italic' : 'normal'};
            color: ${styleName === 'simple' ? gs.color : (styleName === 'corporate' ? 'white' : '#0f172a')};
            font-size: ${gs.fontSize}px;
            pointer-events: all; outline: none;
        `;

        let subTextStyle = `
            text-transform: ${gs.textCase === 'uppercase' ? 'uppercase' : 'none'};
            text-align: ${gs.textAlign};
            color: ${styleName === 'corporate' ? '#e2e8f0' : '#64748b'};
            font-size: ${Math.max(8, gs.fontSize - 3)}px;
            pointer-events: all; outline: none;
        `;

        let empNameStyle = `
            text-transform: ${gs.textCase === 'uppercase' ? 'uppercase' : 'capitalize'};
            text-align: ${gs.textAlign};
            font-weight: 700;
            color: ${styleName === 'corporate' ? 'white' : '#1e293b'};
            font-size: ${Math.max(10, gs.fontSize - 1)}px;
            pointer-events: all; outline: none;
        `;

        let content = '';
        const wrapperStyle = 'min-width: 220px; pointer-events:none;';

        if (styleName === 'simple') {
            textStyle = textStyle.replace('white', gs.color);
            content = `
            <div style="${wrapperStyle} border: 2px solid ${gs.color}; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <div style="border-bottom: 2px solid ${gs.color}; padding: 10px; ${textStyle}" contenteditable="true">${title}</div>
                ${nodeType === 'full_info' ? `
                <div style="padding: 10px;">
                    <div style="${subTextStyle}; color: ${gs.color}; opacity: 0.8;" contenteditable="true">${pos}</div>
                    <div style="${empNameStyle}; color: ${gs.color};" contenteditable="true">${empName}</div>
                </div>` : ''}
            </div>`;
        }
        else if (styleName === 'corporate') {
            content = `
            <div style="${wrapperStyle} border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); padding: 12px; ${textStyle}" contenteditable="true">${title}</div>
                ${nodeType === 'full_info' ? `
                <div style="padding: 15px; background: #f8fafc;">
                    <div style="${subTextStyle}" contenteditable="true">${pos}</div>
                    <div style="${empNameStyle}; color:#1e293b;" contenteditable="true">${empName}</div>
                </div>` : ''}
            </div>`;
        }
        else {
            content = `
            <div style="${wrapperStyle} border-left: 5px solid #3b82f6; background: white; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                <div style="${textStyle}; color: #0f172a;" contenteditable="true">${title}</div>
                ${nodeType === 'full_info' ? `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e2e8f0;">
                     <div style="${empNameStyle}; color: #3b82f6;" contenteditable="true">${empName}</div>
                </div>
                ` : ''}
            </div>`;
        }
        return content;
    }

    function applyGlobalSettings() {
        const style = document.getElementById('template_style').value;
        const data = editor.export();
        for (const id in data.drawflow.Home.data) {
            const node = data.drawflow.Home.data[id];
            node.html = generateNodeHTML(node.name, node.data.title, node.data.emp, node.data.pos, style);
        }
        editor.clear();
        editor.import(data);
    }

    // --- DRAG & DROP & SAVE ---
    function allowDrop(ev) { ev.preventDefault(); }
    function drag(ev) {
        ev.dataTransfer.setData("type", ev.target.getAttribute("data-node-type"));
        ev.dataTransfer.setData("name", ev.target.getAttribute("data-node-name"));
        ev.dataTransfer.setData("pos", ev.target.getAttribute("data-node-pos") || "LAVOZIM");
    }
    function drop(ev) {
        ev.preventDefault();
        const type = ev.dataTransfer.getData("type");
        const name = ev.dataTransfer.getData("name");
        const pos = ev.dataTransfer.getData("pos");

        const rect = container.getBoundingClientRect();
        const zoom = editor.zoom;
        const x = (ev.clientX - rect.left) * (editor.precanvas.clientWidth / (container.clientWidth * zoom));
        const y = (ev.clientY - rect.top) * (editor.precanvas.clientHeight / (container.clientHeight * zoom));

        createNode(type, name, name, x, y, pos);
    }

    function createNode(nodeType, title, empName, x, y, pos) {
        const styleName = document.getElementById('template_style').value;
        const html = generateNodeHTML(nodeType, title, empName, pos, styleName);
        // MUHIM: 4 ta kirish, 4 ta chiqish (Tepa, O'ng, Past, Chap)
        editor.addNode(nodeType, 4, 4, x, y, nodeType, { title, emp: empName, pos: pos }, html);
    }

    function toggleEmployees(id, el) {
        const list = document.getElementById(id);
        const icon = el.querySelector('.fa-chevron-down');
        if (list.style.display === 'block') {
            list.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        } else {
            list.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        }
    }

    async function saveData() {
        const data = editor.export();
        data.globalSettings = globalSettings;
        const title = document.getElementById('struct_title').value;
        const style = document.getElementById('template_style').value;

        await fetch(window.location.href, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({title, template_style: style, structure_data: data})
        }).then(() => alert("Muvaffaqiyatli saqlandi!"));
    }

    // --- PDF EXPORT (A4/A3 MOSLASHTIRILGAN) ---
    async function exportFile() {
        const el = document.getElementById("drawflow");

        const originalBgImage = el.style.backgroundImage;
        el.style.backgroundImage = 'none';
        el.style.backgroundColor = '#ffffff';

        editor.zoom_reset();

        const canvas = await html2canvas(el, {
            scale: 2,
            useCORS: true
        });

        const format = globalSettings.paperFormat || 'a4';
        const orientation = globalSettings.paperOrientation === 'landscape' ? 'l' : 'p';

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF(orientation, 'mm', format);

        const imgData = canvas.toDataURL('image/png');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`${document.getElementById('struct_title').value}.pdf`);

        el.style.backgroundImage = originalBgImage;
        el.style.backgroundColor = 'var(--df-bg-color)';
    }

    updateToolbarUI();
</script>
{% endblock %}