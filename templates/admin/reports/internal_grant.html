{% extends "admin/base_site.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
    :root {
        --primary-color: #2c3e50;
        --bg-color: #f4f6f9;
        --card-bg: #ffffff;
        --filter-btn-bg: #495057; /* Rasmga o'xshash to'q kulrang */
        --filter-btn-hover: #343a40;
        --text-color: #333;
    }

    body { background-color: var(--bg-color); font-family: 'Inter', sans-serif; }
    .dashboard-container { padding: 20px; max-width: 100%; margin: 0 auto; }

    /* HEADER */
    .report-header {
        display: flex; justify-content: space-between; align-items: center;
        background: #fff; padding: 15px 25px; border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .report-title h1 { font-size: 22px; font-weight: 700; color: var(--primary-color); margin: 0; }
    .header-actions { display: flex; gap: 10px; }
    .action-btn {
        display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        padding: 8px 16px; border-radius: 4px; font-weight: 600; font-size: 13px;
        text-decoration: none; cursor: pointer; border: none; color: #fff !important;
        transition: all 0.2s;
    }
    .btn-print { background-color: #6c757d; }
    .btn-excel { background-color: #198754; }

    /* --- YANGI FILTER BAR DIZAYNI (RASMDAGIDEK) --- */
    .filter-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .custom-select-container {
        position: relative;
    }

    /* Tugma ko'rinishidagi selectlar */
    .filter-btn {
        background-color: var(--filter-btn-bg);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 120px;
        text-transform: uppercase;
        transition: background 0.2s;
    }

    .filter-btn:hover { background-color: var(--filter-btn-hover); }
    .filter-btn i { margin-left: 10px; font-size: 11px; }

    /* Dropdown menyusi */
    .dropdown-menu {
        display: none;
        position: absolute;
        top: 105%;
        left: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        z-index: 100;
        min-width: 220px;
        max-height: 300px;
        overflow-y: auto;
        padding: 8px 0;
    }
    .dropdown-menu.show { display: block; }

    .dropdown-search { padding: 8px 12px; border-bottom: 1px solid #eee; position: sticky; top: 0; background: white; }
    .dropdown-search input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }

    .dropdown-item {
        padding: 8px 15px;
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 13px;
        color: #333;
        transition: background 0.1s;
    }
    .dropdown-item:hover { background-color: #f8f9fa; }
    .dropdown-item input { margin-right: 10px; accent-color: var(--primary-color); transform: scale(1.1); }

    /* Date Picker Button */
    .date-picker-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }
    .date-trigger-btn {
        background-color: var(--filter-btn-bg);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }
    .date-trigger-btn:hover { background-color: var(--filter-btn-hover); }
    /* Hide actual input visually but keep functionality */
    .flatpickr-input { display: none; }

    /* Apply button inside dropdown */
    .apply-btn {
        display: block; width: 90%; margin: 8px auto;
        padding: 6px; background: #3b82f6; color: white; text-align: center;
        border-radius: 4px; border: none; cursor: pointer; font-size: 12px;
    }

    /* STATS CARDS */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; border-left: 4px solid; }
    .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; }
    .stat-info h3 { margin: 0; font-size: 12px; color: #7f8c8d; text-transform: uppercase; }
    .stat-info p { margin: 2px 0 0; font-size: 20px; font-weight: 700; color: var(--primary-color); }
    .card-blue { border-color: #3498db; } .card-blue .stat-icon { background-color: #3498db; }
    .card-orange { border-color: #e67e22; } .card-orange .stat-icon { background-color: #e67e22; }

    /* TABLES */
    .main-table-wrapper { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 20px; }
    .table-scroll-container { max-height: 550px; overflow-y: auto; }
    .full-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .full-table thead th { background-color: #2c3e50; color: white; padding: 12px; text-align: left; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    .full-table tbody td { padding: 8px 12px; border-bottom: 1px solid #eee; color: #333; }
    .money { font-family: 'Consolas', monospace; font-weight: 600; }
    .text-center { text-align: center; } .text-right { text-align: right; }
    .tag { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: #e3f2fd; color: #1565c0; white-space: nowrap; }

    /* Analysis Grid */
    .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .analysis-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .mini-table th { padding: 6px; text-align: left; border-bottom: 1px solid #eee; color: #777; font-size: 12px; }
    .mini-table td { padding: 6px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }

</style>

<div class="dashboard-container">

    <div class="report-header">
        <div class="report-title">
            <h1>Ichki Grant va Chegirmalar</h1>
            <p>Universitet tomonidan ajratilgan imtiyozlar tahlili</p>
        </div>
        <div class="header-actions">
            <button onclick="window.print()" class="action-btn btn-print"><i class="fas fa-print"></i></button>
            <a href="#" onclick="exportToExcel(event)" class="action-btn btn-excel"><i class="fas fa-file-excel"></i> Excel</a>
        </div>
    </div>

    <form method="get" id="filterForm" class="filter-bar">

        <div class="custom-select-container">
            <button type="button" class="filter-btn" onclick="toggleDropdown('yearDrop')">
                <span id="yearLabel">O'QUV YILI</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div id="yearDrop" class="dropdown-menu">
                {% for y in years %}
                <label class="dropdown-item">
                    <input type="checkbox" name="year" value="{{ y.id }}"
                        {% if y.id|stringformat:"s" in selected_years %}checked{% endif %}
                        onchange="submitForm()">
                    {{ y.name }}
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="custom-select-container">
            <button type="button" class="filter-btn" onclick="toggleDropdown('typeDrop')">
                <span id="typeLabel">CHEGIRMA TURI</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div id="typeDrop" class="dropdown-menu">
                {% for code, name in grant_types %}
                <label class="dropdown-item">
                    <input type="checkbox" name="grant_type" value="{{ code }}"
                        {% if code in selected_grant_types %}checked{% endif %}
                        onchange="submitForm()">
                    {{ name }}
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="custom-select-container">
            <button type="button" class="filter-btn" onclick="toggleDropdown('courseDrop')">
                <span id="courseLabel">KURS</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div id="courseDrop" class="dropdown-menu">
                {% for c_num, c_name in courses %}
                <label class="dropdown-item">
                    <input type="checkbox" name="course" value="{{ c_num }}"
                        {% if c_num|stringformat:"s" in selected_courses %}checked{% endif %}
                        onchange="submitForm()">
                    {{ c_name }}
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="custom-select-container">
            <button type="button" class="filter-btn" onclick="toggleDropdown('groupDrop')">
                <span id="groupLabel">GURUH</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div id="groupDrop" class="dropdown-menu">
                <div class="dropdown-search">
                    <input type="text" placeholder="Qidirish..." onkeyup="filterGroups(this)">
                </div>
                <div id="groupListContainer">
                    {% for g in all_groups %}
                    <label class="dropdown-item group-item">
                        <input type="checkbox" name="group" value="{{ g.id }}"
                            {% if g.id|stringformat:"s" in selected_groups %}checked{% endif %}
                            onchange="submitForm()">
                        {{ g.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="date-picker-wrapper">
            <input type="text" id="dateInput" name="date" class="flatpickr-input"
                   value="{{ selected_date|default:'' }}" placeholder="Vaqtni tanlang">
            <button type="button" class="date-trigger-btn" onclick="openDate()">
                <i class="fas fa-calendar-alt"></i>
                <span id="dateDisplay">
                    {% if selected_date %}{{ selected_date }}{% else %}VAQT{% endif %}
                </span>
            </button>
            {% if selected_date %}
            <a href="#" onclick="clearDate(event)" style="margin-left: 5px; color: #e74c3c;"><i class="fas fa-times"></i></a>
            {% endif %}
        </div>

    </form>

    <div class="stats-grid">
        <div class="stat-card card-blue">
            <div class="stat-icon"><i class="fas fa-user-graduate"></i></div>
            <div class="stat-info">
                <h3>Jami Chegirma Olganlar</h3>
                <p>{{ stats.total_students }} nafar</p>
            </div>
        </div>
        <div class="stat-card card-orange">
            <div class="stat-icon"><i class="fas fa-coins"></i></div>
            <div class="stat-info">
                <h3>Jami Ajratilgan Summa</h3>
                <p class="money" style="color: #e67e22;">{{ stats.total_sum|intcomma }}</p>
            </div>
        </div>
    </div>

    <div class="main-table-wrapper">
        <div class="table-scroll-container">
            <table class="full-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">â„–</th>
                        <th style="min-width: 200px;">F.I.SH / ID</th>
                        <th>Guruh</th>
                        <th class="text-center">Kurs</th>
                        <th>Chegirma Turi</th>
                        <th class="text-center">Foiz</th>
                        <th class="text-right">Chegirma</th>
                        <th class="text-right">Kontrakt</th>
                    </tr>
                </thead>
                <tbody>
                    {% for st in detailed_list %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <div style="font-weight: 600;">{{ st.full_name }}</div>
                            <div style="font-size: 11px; color: #7f8c8d;">{{ st.hemis_id|default:"-" }}</div>
                        </td>
                        <td>{{ st.group }}</td>
                        <td class="text-center">{{ st.course }}</td>
                        <td><span class="tag">{{ st.grant_type }}</span></td>
                        <td class="text-center">{% if st.percent %}{{ st.percent|floatformat:0 }}%{% else %}-{% endif %}</td>
                        <td class="text-right money" style="color: #c0392b;">{{ st.grant_amount|intcomma }}</td>
                        <td class="text-right money" style="color: #7f8c8d;">{{ st.contract_amount|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="8" class="text-center" style="padding: 20px;">Ma'lumot yo'q</td></tr>
                    {% endfor %}
                </tbody>
                {% if detailed_list %}
                <tfoot style="background: #ecf0f1; font-weight: bold; position: sticky; bottom: 0;">
                    <tr>
                        <td colspan="6" class="text-right" style="padding: 10px;">JAMI:</td>
                        <td class="text-right money" style="color: #c0392b;">{{ stats.total_sum|intcomma }}</td>
                        <td></td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>

    <div class="analysis-grid">
        <div class="analysis-card">
            <div class="card-title">Chegirma turlari bo'yicha</div>
            <table class="mini-table">
                <thead><tr><th>Nomi</th><th class="text-center">Soni</th><th class="text-right">Summasi</th></tr></thead>
                <tbody>
                    {% for item in by_type_stats %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td class="text-center"><b>{{ item.count }}</b></td>
                        <td class="text-right money">{{ item.sum|intcomma }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="analysis-card">
            <div class="card-title">Yo'nalishlar bo'yicha (Top)</div>
             <div style="max-height: 200px; overflow-y: auto;">
                <table class="mini-table">
                    <thead><tr><th>Yo'nalish</th><th class="text-center">Soni</th><th class="text-right">Summasi</th></tr></thead>
                    <tbody>
                        {% for name, val in sorted_spec_stats %}
                        <tr>
                            <td>{{ name }}</td>
                            <td class="text-center"><b>{{ val.count }}</b></td>
                            <td class="text-right money">{{ val.sum|intcomma }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
             </div>
        </div>
    </div>

</div>

<script>
    // 1. Sana tanlagich (Flatpickr)
    const fp = flatpickr("#dateInput", {
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            document.getElementById('filterForm').submit();
        }
    });

    function openDate() {
        fp.open();
    }

    function clearDate(e) {
        e.preventDefault();
        const input = document.getElementById('dateInput');
        input.value = "";
        document.getElementById('filterForm').submit();
    }

    // 2. Dropdown Logic
    function toggleDropdown(id) {
        document.querySelectorAll('.dropdown-menu').forEach(d => {
            if(d.id !== id) d.classList.remove('show');
        });
        document.getElementById(id).classList.toggle('show');
    }

    // Tashqariga bosganda yopish
    window.onclick = function(event) {
        if (!event.target.closest('.custom-select-container')) {
            document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('show'));
        }
    }

    // 3. Guruh qidirish
    function filterGroups(input) {
        var filter = input.value.toUpperCase();
        var items = document.querySelectorAll('.group-item');
        items.forEach(item => {
            var txt = item.textContent || item.innerText;
            if (txt.toUpperCase().indexOf(filter) > -1) {
                item.style.display = "";
            } else {
                item.style.display = "none";
            }
        });
    }

    // 4. Formani avtomatik yuborish (checkbox o'zgarganda)
    function submitForm() {
        document.getElementById('filterForm').submit();
    }

    function exportToExcel(e) {
        e.preventDefault();
        const searchParams = window.location.search;
        window.location.href = 'export/' + searchParams;
    }
</script>
{% endblock %}