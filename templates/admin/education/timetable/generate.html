{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* 1. ASOSIY KONTEYNER */
    .dashboard-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        padding: 20px 0 50px 0;
        max-width: 100%;
        color: #333;
    }

    h1.page-title {
        color: #2c3e50;
        margin-bottom: 25px;
        font-size: 24px;
        font-weight: 700;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* 2. FORM BOSHQARUV PANELI */
    .controls-wrapper {
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-left: 5px solid #2c3e50;
        margin-bottom: 30px;

        display: flex;
        flex-wrap: wrap; /* Sig'masa pastga tushadi */
        gap: 30px;
        align-items: stretch; /* Balandligi bir xil bo'lishi uchun */
    }

    /* Chap tomon: Selectlar */
    .control-group-selects {
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 220px;
    }

    .form-label {
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
        color: #555;
        font-size: 13px;
        text-transform: uppercase;
    }

    .form-select {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ced4da;
        width: 100%;
        font-size: 14px;
        background-color: #f8f9fa;
        transition: border-color 0.2s;
    }
    .form-select:focus { border-color: #80bdff; outline: none; background: #fff; }

    /* O'rta tomon: Smena */
    .shift-section {
        flex: 2;
        border-left: 1px solid #dee2e6;
        padding-left: 25px;
        min-width: 400px;
    }

    .shift-header {
        font-size: 14px; font-weight: 700; color: #2c3e50; margin-bottom: 15px;
        display: flex; align-items: center; gap: 8px;
    }

    .shift-grid {
        display: flex; gap: 20px; flex-wrap: wrap;
    }

    .shift-col {
        background: #f8f9fa;
        padding: 12px 15px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        flex: 1;
        min-width: 180px;
    }

    .shift-col-title {
        font-size: 12px; font-weight: 800; display: block; margin-bottom: 10px;
        text-transform: uppercase; border-bottom: 1px solid #ddd; padding-bottom: 5px;
    }

    .checkbox-label {
        font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;
        font-size: 14px; margin-bottom: 6px; user-select: none;
    }
    .checkbox-label input { width: 16px; height: 16px; cursor: pointer; accent-color: #2c3e50; }
    .checkbox-label:hover { color: #007bff; }

    /* O'ng tomon: Tugmalar */
    .actions-group {
        display: flex;
        flex-direction: column;
        justify-content: flex-end; /* Pastga taqaladi */
        gap: 10px;
        min-width: 200px;
        margin-left: auto; /* O'ngga surish uchun */
    }

    .btn-action {
        width: 100%;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-transform: uppercase;
        text-decoration: none;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-preview { background: #17a2b8; color: white; }
    .btn-preview:hover { background: #138496; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3); }

    .btn-save { background: #28a745; color: white; }
    .btn-save:hover { background: #218838; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3); }

    /* 3. STATISTIKA KARTALARI */
    .stats-container {
        display: flex; gap: 20px; margin-bottom: 30px;
    }
    .stat-card {
        flex: 1; background: white; padding: 20px; border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        display: flex; align-items: center; justify-content: space-between;
        border-bottom: 4px solid transparent; transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-3px); }
    .stat-card.blue { border-bottom-color: #007bff; }
    .stat-card.green { border-bottom-color: #28a745; }
    .stat-card.red { border-bottom-color: #dc3545; }

    .stat-info h3 { margin: 0; font-size: 32px; font-weight: 700; color: #333; line-height: 1; }
    .stat-info p { margin: 8px 0 0; color: #6c757d; font-size: 12px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
    .stat-icon { font-size: 40px; opacity: 0.15; }

    /* 4. XATOLIKLAR RO'YXATI */
    .error-section { margin-bottom: 40px; }
    .error-card {
        background: #fff; border-left: 5px solid #dc3545;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; padding: 15px 20px;
        border-radius: 6px; display: flex; justify-content: space-between; align-items: center;
    }
    .error-content h4 { margin: 0 0 5px 0; color: #c0392b; font-size: 16px; font-weight: 700; }
    .error-details { font-size: 14px; color: #555; }
    .suggestion-badge {
        background: #f8f9fa; border: 1px dashed #adb5bd; padding: 5px 10px;
        border-radius: 4px; font-size: 12px; color: #495057; font-weight: 600;
    }

    /* 5. JADVAL GRIDI */
    .group-container {
        margin-bottom: 50px; background: #fff; border: 1px solid #e9ecef;
        border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); overflow: hidden;
    }
    .group-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 12px 20px; border-bottom: 1px solid #dee2e6;
        display: flex; justify-content: space-between; align-items: center;
    }
    .group-title { font-size: 18px; color: #2c3e50; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .group-badge { background: #343a40; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }

    .schedule-grid { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .schedule-grid th {
        background: #343a40; color: #fff; padding: 10px; text-align: center;
        border: 1px solid #454d55; font-weight: 600; text-transform: uppercase; font-size: 12px;
    }
    .schedule-grid td {
        border: 1px solid #dee2e6; padding: 5px; vertical-align: top;
        background: #fff; height: 100px; width: 15%;
    }
    .time-cell {
        background: #f1f3f5 !important; text-align: center; vertical-align: middle !important;
        font-weight: bold; color: #495057; width: 80px; border-right: 2px solid #dee2e6;
    }

    /* 6. DARS BLOKI (Lesson Card) */
    .lesson-card {
        border-radius: 4px; padding: 5px 6px; margin-bottom: 4px;
        border-left: 4px solid #007bff; background: #f8f9fa;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 11px;
        position: relative; transition: all 0.2s; cursor: default;
    }
    .lesson-card:hover { transform: translateY(-2px); z-index: 5; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

    .type-lecture { border-left-color: #28a745; background: #e8f5e9; }
    .type-practice { border-left-color: #007bff; background: #e3f2fd; }
    .type-lab { border-left-color: #e83e8c; background: #fce4ec; }
    .type-seminar { border-left-color: #fd7e14; background: #fff3e0; }

    .lesson-subject { font-weight: 700; color: #212529; margin-bottom: 2px; line-height: 1.2; font-size: 11px; }
    .lesson-teacher { color: #666; margin-bottom: 3px; display: flex; align-items: center; gap: 4px; font-size: 10px; }
    .lesson-footer { display: flex; justify-content: space-between; margin-top: 3px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 3px; }

    .room-badge {
        font-weight: 700; color: #198754; background: rgba(25, 135, 84, 0.1);
        padding: 0 4px; border-radius: 3px; font-size: 10px;
    }
    .lesson-type-badge { font-size: 9px; text-transform: uppercase; color: #adb5bd; font-weight: 600; }
    .big-stream-indicator {
        position:absolute; top:-4px; right:-4px; background:#fd7e14; color:white;
        border-radius:50%; width:14px; height:14px; font-size:9px;
        text-align:center; line-height:14px;
    }

</style>
{% endblock %}

{% block content %}
<div id="content-main" class="dashboard-container">
    <h1 class="page-title"><i class="fas fa-magic"></i> Avtomatik Dars Jadvali Generatori</h1>

    <form method="POST">
        {% csrf_token %}
        <div class="controls-wrapper">

            <div class="control-group-selects">
                <div>
                    <label class="form-label">O'quv yili</label>
                    <select name="academic_year" required class="form-select">
                        {% for y in academic_years %}
                            <option value="{{ y.id }}" {% if selected_year == y.id %}selected{% endif %}>{{ y.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="form-label">Mavsum (Semestr)</label>
                    <select name="season" required class="form-select">
                        <option value="autumn" {% if selected_season == 'autumn' %}selected{% endif %}>Kuzgi (1, 3, 5...)</option>
                        <option value="spring" {% if selected_season == 'spring' %}selected{% endif %}>Bahorgi (2, 4, 6...)</option>
                    </select>
                </div>
            </div>

            <div class="shift-section">
                <div class="shift-header">
                    <i class="fas fa-layer-group"></i> Smena taqsimoti (Kurslar kesimida)
                </div>

                <div class="shift-grid">
                    <div class="shift-col">
                        <span class="shift-col-title" style="color: #e67e22;">
                            <i class="fas fa-sun"></i> 1-smena (Ertalab)
                        </span>

                        {% for i in "1234"|make_list %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="shift1_levels" value="{{ i }}"
                                {% if i|add:"0" in selected_shift1 %}checked{% endif %}>
                            {{ i }}-kurs
                        </label>
                        {% endfor %}

                        <label class="checkbox-label" style="color:#d63384; font-weight:bold; margin-top: 5px;" title="Kun bo'yi dars">
                            <input type="checkbox" name="shift1_levels" value="5"
                                {% if 5 in selected_shift1 %}checked{% endif %}>
                            5 (Sirtqi)
                        </label>
                        <div style="font-size:10px; color:#999; margin-top:5px;">(1, 2, 3, 4 - paralar)</div>
                    </div>

                    <div class="shift-col">
                        <span class="shift-col-title" style="color: #34495e;">
                            <i class="fas fa-moon"></i> 2-smena (Tushlikdan keyin)
                        </span>

                        {% for i in "1234"|make_list %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="shift2_levels" value="{{ i }}"
                                {% if i|add:"0" in selected_shift2 %}checked{% endif %}>
                            {{ i }}-kurs
                        </label>
                        {% endfor %}

                        <label class="checkbox-label" style="color:#d63384; font-weight:bold; margin-top: 5px;">
                            <input type="checkbox" name="shift2_levels" value="5"
                                {% if 5 in selected_shift2 %}checked{% endif %}>
                            5
                        </label>
                        <div style="font-size:10px; color:#999; margin-top:5px;">(3, 4, 5, 6 - paralar)</div>
                    </div>
                </div>
            </div>

            <div class="actions-group">
                <button type="submit" name="action" value="preview" class="btn-action btn-preview">
                    <i class="fas fa-vial"></i> Simulyatsiya
                </button>

                {% if preview_mode %}
                <button type="submit" name="action" value="save" class="btn-action btn-save" onclick="return confirm('DIQQAT! Agar saqlasangiz, ushbu semestr uchun eski jadval o\'chiriladi va yangisi yoziladi. Tasdiqlaysizmi?')">
                    <i class="fas fa-save"></i> Bazaga Saqlash
                </button>
                {% endif %}
            </div>

        </div>
    </form>


    {% if preview_mode %}

        <div class="stats-container">
            <div class="stat-card blue">
                <div class="stat-info">
                    <h3>{{ total_streams }}</h3>
                    <p>Jami Darslar (Yuklamalar)</p>
                </div>
                <div class="stat-icon"><i class="fas fa-stream" style="color: #007bff;"></i></div>
            </div>
            <div class="stat-card green">
                <div class="stat-info">
                    <h3>{{ success_percent }}%</h3>
                    <p>Muvaffaqiyatli</p>
                </div>
                <div class="stat-icon"><i class="fas fa-check-circle" style="color: #28a745;"></i></div>
            </div>
            <div class="stat-card red">
                <div class="stat-info">
                    <h3>{{ errors|length }}</h3>
                    <p>Joylashmagan</p>
                </div>
                <div class="stat-icon"><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i></div>
            </div>
        </div>

        {% if errors %}
        <div class="error-section">
            <h2 style="color: #c0392b; margin-bottom: 15px; font-size: 20px;">
                <i class="fas fa-times-circle"></i> Joylashmay qolgan darslar tahlili
            </h2>

            {% for err in errors %}
            <div class="error-card">
                <div class="error-content">
                    <h4>
                        <i class="fas fa-book"></i> {{ err.workload.subject.name }}
                        <span style="font-size: 13px; color: #666; font-weight: normal;">
                            ({{ err.workload.plan_subjects.first.get_lesson_type_display }})
                        </span>
                    </h4>
                    <div class="error-details">
                        O'qituvchi: <b>{{ err.workload.stream_set.first.teacher }}</b> <br>
                        <i class="fas fa-info-circle"></i> Sabab: {{ err.reason }}
                    </div>
                </div>
                <div class="suggestion-badge">
                    <i class="fas fa-lightbulb" style="color: #f39c12;"></i>
                    {% if "Soatbay" in err.reason %}
                        Tavsiya: Soatbay o'qituvchi vaqtini ko'paytiring
                    {% elif "xona" in err.reason %}
                        Tavsiya: Xonalar yetishmayapti
                    {% elif "Guruh" in err.reason %}
                        Tavsiya: Guruh darslari zich
                    {% else %}
                        Tavsiya: Yuklamani tekshiring
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: center; border: 1px solid #c3e6cb;">
                <h3 style="margin:0;"><i class="fas fa-check-double"></i> Ajoyib! Barcha darslar muvaffaqiyatli joylashtirildi.</h3>
            </div>
        {% endif %}

        {% if not grouped_schedules %}
            <div style="text-align: center; color: #666; padding: 40px; background: #fff; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <h3>Ma'lumot topilmadi</h3>
                <p>Tanlangan parametrlarga mos darslar yoki o'qituvchilar topilmadi.</p>
            </div>
        {% else %}

            {% for item in grouped_schedules %}
            <div class="group-container">
                <div class="group-header">
                    <div class="group-title">
                        <i class="fas fa-users" style="color: #495057;"></i> {{ item.group.name }}
                    </div>
                    <div class="group-badge">
                        {{ item.group.specialty.name }} | {{ item.course_level }}-kurs
                    </div>
                </div>

                <table class="schedule-grid">
                    <thead>
                        <tr>
                            <th width="90"><i class="far fa-clock"></i> Vaqt</th>
                            {% for day in weekdays %}
                                <th>{{ day.name }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for slot in timeslots %}
                        <tr>
                            <td class="time-cell">
                                {{ slot.start_time|time:"H:i" }}<br>
                                <span style="font-size:11px; color:#adb5bd; font-weight:normal;">{{ slot.end_time|time:"H:i" }}</span>
                            </td>

                            {% for day in weekdays %}
                            <td>
                                {% for s_id, day_data in item.grid.items %}
                                    {% if s_id == slot.id %}
                                        {% for d_id, lessons in day_data.items %}
                                            {% if d_id == day.id %}
                                                {% for lesson in lessons %}
                                                    <div class="lesson-card {% if 'Ma\'ruza' in lesson.label %}type-lecture{% elif 'Amaliyot' in lesson.label %}type-practice{% elif 'Lab' in lesson.label %}type-lab{% else %}type-seminar{% endif %}">

                                                        <div class="lesson-subject">{{ lesson.subject_name }}</div>

                                                        <div class="lesson-teacher">
                                                            <i class="fas fa-user-tie"></i>
                                                            {{ lesson.teacher_name|truncatechars:18 }}
                                                        </div>

                                                        <div class="lesson-footer">
                                                            <span class="lesson-type-badge">{{ lesson.label|truncatewords:1 }}</span>

                                                            {% if lesson.room_name %}
                                                                <span class="room-badge">
                                                                    <i class="fas fa-door-open"></i> {{ lesson.room_name }}
                                                                </span>
                                                            {% else %}
                                                                <span style="color:red; font-size:9px; font-weight:bold;">!Xona</span>
                                                            {% endif %}
                                                        </div>

                                                        {% if lesson.student_count > 40 %}
                                                            <div class="big-stream-indicator" title="Katta oqim">!</div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}

        {% endif %}

    {% endif %}

</div>
{% endblock %}