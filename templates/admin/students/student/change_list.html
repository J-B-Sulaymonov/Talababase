{% extends "admin/change_list.html" %}
{% load i18n static humanize %}

{% block extrahead %}
{{ block.super }}

<script id="groups-data" type="application/json">
    {{ groups_json|safe }}
</script>

{# --- STATISTIKA BLOKI --- #}
<div id="stats-data-source" style="display: none;">
    <div class="stats-dashboard-widget">
        <div class="stat-box students">
            <div class="stat-icon"><i class="fas fa-users"></i></div>
            <div class="stat-info">
                <span class="stat-label">Jami talabalar</span>
                <span class="stat-value">{{ cl.result_count|intcomma }}</span>
            </div>
        </div>
        {# --- SHART BOSHLANISHI: Faqat Admin, Iskandar va direktor uchun --- #}
        {% if user.is_superuser or user.username == 'Iskandar' or user.username == 'direktor' %}
            <div class="stat-box contract">
                <div class="stat-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Jami kontrakt</span>
                    <span class="stat-value">{{ footer_stats.contract|floatformat:0|intcomma|default:"0" }}</span>
                </div>
            </div>

            <div class="stat-box grant">
                <div class="stat-icon"><i class="fas fa-hand-holding-heart"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Chegirma</span>
                    <span class="stat-value">{{ footer_stats.grant|floatformat:0|intcomma|default:"0" }}</span>
                </div>
            </div>
        <div class="stat-box real-contract">
                <div class="stat-icon"><i class="fas fa-coins"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Real Kontrakt</span>
                    <span class="stat-value">{{ footer_stats.real_contract|floatformat:0|intcomma|default:"0" }}</span>
                </div>
            </div>

            <div class="stat-box paid">
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                <div class="stat-info">
                    <span class="stat-label">To'langan</span>
                    <span class="stat-value">{{ footer_stats.paid|floatformat:0|intcomma|default:"0" }}</span>
                </div>
            </div>
            <div class="stat-box debt">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-info">
                    <span class="stat-label">Joriy Qarz</span>
                    <span class="stat-value">{{ footer_stats.debt|floatformat:0|intcomma|default:"0" }}</span>
                </div>
            </div>
        {% endif %}
        {# --- STATISTIKA TUGADI --- #}
    </div>
</div>

<style>
    /* JADVAL DIZAYNLARI */
    #result_list { border-collapse: separate !important; border-spacing: 0 8px !important; width: 100%; border: none !important; margin-top: 10px; }

    /* HEADER (Sarlavha) qismi - OQ RANG QAYTARILDI */
    #result_list thead th { background-color: #2c3e50; color: #ffffff !important; font-weight: 600; text-transform: uppercase; font-size: 13px; padding: 16px 12px; border: none; vertical-align: middle; position: relative; white-space: nowrap; }

    /* Linklar (a) ham oq bo'lishi shart */
    #result_list thead th a { color: #ffffff !important; text-decoration: none; }
    #result_list thead th a:hover { color: #dbe4ff !important; text-decoration: underline; }

    #result_list tbody tr { background-color: #ffffff; box-shadow: 0 3px 6px rgba(0,0,0,0.04); transition: all 0.2s; border-radius: 8px; }
    #result_list tbody tr:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); z-index: 100; position: relative; }
    #result_list tbody td, #result_list tbody th { padding: 12px 14px; vertical-align: middle; border: none; font-size: 15px; color: #2d3436; font-weight: 500; height: 60px; }
    #result_list tbody tr td:first-child, #result_list tbody tr th:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
    #result_list tbody tr td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

    /* Summalar bir qatorda */
    #result_list .field-get_contract_amount, #result_list .field-get_total_payment, #result_list .field-get_payment_debt,
    #result_list .field-get_subject_debt_amount, #result_list .field-get_subject_debt_paid, #result_list .field-get_subject_debt_diff {
        white-space: nowrap !important; min-width: 120px;
    }

    /* Badges */
    .status-badge { display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 50px; font-size: 12px; font-weight: 700; min-width: 80px; white-space: nowrap; }
    .badge-success { background-color: #e6fcf5; color: #0ca678; border: 1px solid #c3fae8; }
    .badge-warning { background-color: #fff9db; color: #f08c00; border: 1px solid #ffec99; }
    .badge-danger  { background-color: #fff5f5; color: #fa5252; border: 1px solid #ffc9c9; }
    .badge-info    { background-color: #e7f5ff; color: #1c7ed6; border: 1px solid #a5d8ff; }
    .badge-secondary { background-color: #f8f9fa; color: #868e96; border: 1px solid #e9ecef; }
    .group-badge { background: #f1f3f5; color: #495057; font-weight: 600; padding: 6px 10px; border-radius: 6px; font-size: 13px; border: 1px solid #dee2e6; white-space: nowrap; display: inline-block; }

    /* Filter Icons */
    .excel-filter-wrapper { display: inline-flex; align-items: center; margin-left: 8px; position: relative; z-index: 900; vertical-align: middle; }
    .excel-filter-btn { background-color: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 6px; color: #fff; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; transition: all 0.2s; }
    .excel-filter-btn:hover { background-color: rgba(255, 255, 255, 0.4); color: #fff; }
    .excel-filter-btn.active-filter { background-color: #f1c40f; color: #2c3e50; border-color: #f39c12; font-weight: bold; }
    .excel-dropdown { display: none; position: absolute; top: 35px; right: 0; background: white; border: 1px solid #dfe6e9; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 9999; min-width: 260px; border-radius: 8px; text-align: left; padding: 8px 0; }
    .excel-dropdown label { display: flex; align-items: center; padding: 12px 18px; color: #2d3436; font-size: 14px; border-bottom: 1px solid #f1f2f6; cursor: pointer; margin: 0; font-weight: 500; }
    .excel-dropdown label:hover { background-color: #f1f2f6; }
    .excel-dropdown input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; accent-color: #0984e3; }
    .excel-filter-actions { display: flex; justify-content: space-between; padding: 12px 18px; background: #f8f9fa; border-top: 1px solid #dfe6e9; border-radius: 0 0 8px 8px; }
    .btn-apply { background: #00b894; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
    .btn-clear { background: #ff7675; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }

    /* Statistika */
    .stats-dashboard-widget { display: flex; gap: 20px; padding: 20px 0; margin-bottom: 5px; flex-wrap: wrap; }
    .stat-box { display: flex; align-items: center; padding: 15px 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02); min-width: 200px; flex: 1; transition: transform 0.2s; cursor: default; }
    .stat-box:hover { transform: translateY(-3px); }
    .stat-box.students .stat-icon { color: #fff; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-box.contract .stat-icon { color: #fff; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-box.paid .stat-icon { color: #fff; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .stat-box.debt .stat-icon { color: #fff; background: linear-gradient(135deg, #ff0844 0%, #ffb199 100%); }
    .stat-box.grant .stat-icon { color: #fff; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
    .stat-box.real-contract .stat-icon { color: #fff; background: linear-gradient(135deg, #0ba360 0%, #3cba92 100%); }
    .stat-icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 20px; margin-right: 15px; flex-shrink: 0; }
    .stat-info { display: flex; flex-direction: column; }
    .stat-label { font-size: 11px; text-transform: uppercase; color: #adb5bd; font-weight: 700; }
    .stat-value { font-size: 20px; font-weight: 800; color: #212529; white-space: nowrap; }

    /* Modal */
    .export-modal { display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
    .export-modal-content { background-color: #f8f9fa; border-radius: 16px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.25); display: flex; flex-direction: column; }
    .export-modal-header { background: #fff; padding: 20px 30px; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; border-radius: 16px 16px 0 0; }
    .export-modal-header h3 { margin: 0; color: #212529; font-size: 20px; font-weight: 700; display: flex; align-items: center; }
    .close-modal { font-size: 24px; color: #adb5bd; cursor: pointer; transition: 0.2s; }
    .close-modal:hover { color: #fa5252; }
    .export-modal-body { padding: 30px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
    .field-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); border: 1px solid #e9ecef; }
    .field-card-title { font-size: 15px; font-weight: 700; color: #495057; margin-bottom: 15px; display: flex; align-items: center; padding-bottom: 10px; border-bottom: 2px solid #f1f3f5; }
    .checkbox-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .checkbox-item { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; border: 1px solid transparent; color: #495057; font-size: 13px; }
    .checkbox-item:hover { background-color: #f8f9fa; border-color: #dee2e6; }
    .checkbox-item input { accent-color: #107c41; margin-right: 10px; width: 18px; height: 18px; cursor: pointer; }
    .checkbox-item:has(input:checked) { background-color: #f0fff4; border-color: #b2f2bb; color: #2b8a3e; font-weight: 500; }
    .export-modal-footer { background: #fff; padding: 20px 30px; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 15px; border-radius: 0 0 16px 16px; position: sticky; bottom: 0; z-index: 10; }
    .btn-outline { background: transparent; border: 1px solid #ced4da; color: #495057; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-outline:hover { background: #f8f9fa; border-color: #adb5bd; }
    .btn-primary-action { background: #107c41; color: white; border: none; padding: 10px 30px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(16, 124, 65, 0.2); transition: 0.2s; }
    .btn-primary-action:hover { background: #0c5e31; transform: translateY(-1px); }

    .finance-stats-option { grid-column: 1 / -1; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #dee2e6; font-weight: bold; color: #107c41; }

    @media (max-width: 768px) {
        .export-modal-body { grid-template-columns: 1fr; }
        .checkbox-list { grid-template-columns: 1fr; }
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // --- 1. STATISTIKA PANELINI JOYLASH ---
    const statsHTML = document.getElementById('stats-data-source').innerHTML;
    const statsDiv = document.createElement('div');
    statsDiv.innerHTML = statsHTML;

    // Har xil mavzular uchun to'g'ri joyni topish
    const searchBar = document.getElementById('changelist-search');
    const tableForm = document.getElementById('changelist-form');
    let targetForStats = document.getElementById('changelist-filter');

    if (searchBar) {
        targetForStats = targetForStats || searchBar;
        targetForStats.parentNode.insertBefore(statsDiv, targetForStats.nextSibling);
    } else if (tableForm) {
        tableForm.parentNode.insertBefore(statsDiv, tableForm);
    } else {
        // Fallback
        document.querySelector('.content-main').insertBefore(statsDiv, document.querySelector('.content-main').firstChild);
    }

    // --- 2. EXPORT TUGMASINI TEPAGA (ADD STUDENT YONIGA) KO'CHIRISH ---

    // a) Standart Django konteyneri
    let toolsContainer = document.querySelector('ul.object-tools');

    // b) Jazzmin/Bootstrap konteyneri (Agar standart topilmasa)
    if (!toolsContainer) {
        // "Qo'shish" tugmasini qidirib topamiz (yashil tugma)
        const addBtn = document.querySelector('a.btn.btn-success') || document.querySelector('a.addlink');
        if (addBtn) {
            toolsContainer = addBtn.parentElement;
        }
    }

    if (toolsContainer) {
        // Tugmani yaratish
        const exportBtn = document.createElement('a');
        exportBtn.href = "#";
        exportBtn.onclick = function(e) { e.preventDefault(); openExportModal(); };

        // Mavzuga qarab stil berish
        const isJazzmin = document.querySelector('a.btn.btn-success');

        if (isJazzmin) {
            // Jazzmin (Bootstrap) stili
            exportBtn.className = "btn btn-success"; // Ko'k rang yoki o'zingiz xohlagan
            exportBtn.style.cssText = "background-color: #107c41 !important; border-color: #107c41 !important; color: white !important; margin-right: 8px;";
        } else {
            // Standart Django stili
            exportBtn.className = "historylink";
            exportBtn.style.cssText = "background-color: #107c41 !important; color: white !important; border: 1px solid #107c41; cursor: pointer; margin-right: 5px;";
        }

        exportBtn.innerHTML = '<i class="fas fa-file-excel" style="margin-right: 5px;"></i> Excelga yuklash';

        // Joylashtirish
        if (toolsContainer.tagName === 'UL') {
            const li = document.createElement('li');
            li.appendChild(exportBtn);
            // Ro'yxat boshiga qo'shish
            toolsContainer.insertBefore(li, toolsContainer.firstChild);
        } else {
            // DIV ichida bo'lsa (Jazzmin) -> "Add" tugmasidan oldin qo'yamiz
            const addBtn = toolsContainer.querySelector('a.btn.btn-success') || toolsContainer.querySelector('a.addlink');
            if (addBtn) {
                toolsContainer.insertBefore(exportBtn, addBtn);
            } else {
                toolsContainer.appendChild(exportBtn);
            }
        }
    } else {
        console.warn("Export tugmasini joylashtirish uchun joy topilmadi.");
    }

    // --- 3. FILTERLAR ---
    let groupOptions = [];
    try {
        const groupsJson = document.getElementById('groups-data').textContent;
        const groupsData = JSON.parse(groupsJson);
        groupOptions = groupsData.map(g => ({ val: g.id.toString(), label: g.name }));
    } catch(e) { console.error("Guruh JSON xatosi:", e); }

    const eduFormOptions = [
        {val: 'kunduzgi', label: "Kunduzgi"},
        {val: 'sirtqi', label: "Sirtqi"},
        {val: 'kechki', label: "Kechki"},
    ];
    const courseOptions = [
        {val: '1', label: "1-kurs"},
        {val: '2', label: "2-kurs"},
        {val: '3', label: "3-kurs"},
        {val: '4', label: "4-kurs"},
        {val: '5', label: "5-kurs"},
    ];
    const paymentOptions = [
        {val: '0', label: "0% (To'lamagan)"},
        {val: '1-24', label: "1% - 24%"},
        {val: '25', label: "25%"},
        {val: '26-49', label: "26% - 49%"},
        {val: '50', label: "50%"},
        {val: '51-74', label: "51% - 74%"},
        {val: '75', label: "75%"},
        {val: '76-99', label: "76% - 99%"},
        {val: '100', label: "100% (To'liq)"},
        {val: 'over', label: "Ortiqcha (>100%)"},
    ];

    function createExcelFilter(headerTextKeyword, paramName, options) {
        const headers = document.querySelectorAll('#result_list th');
        let targetTh = null;
        headers.forEach(th => {
            const txt = th.innerText.trim().toLowerCase();
            if (txt.includes(headerTextKeyword.toLowerCase())) { targetTh = th; }
        });
        if (!targetTh) return;

        targetTh.style.overflow = "visible"; targetTh.style.position = "relative";
        const params = new URLSearchParams(window.location.search);
        const currentRaw = params.get(paramName) || '';
        const selectedArr = currentRaw.split(',');
        const isActive = currentRaw ? 'active-filter' : '';
        let listItems = '';
        options.forEach(opt => {
            const isChecked = selectedArr.includes(opt.val) ? 'checked' : '';
            listItems += `<label><input type="checkbox" value="${opt.val}" ${isChecked}> ${opt.label}</label>`;
        });

        const html = `
            <div class="excel-filter-wrapper" onclick="event.stopPropagation();">
                <button type="button" class="excel-filter-btn ${isActive}" onclick="toggleExcelFilter(this)" title="Filter"><i class="fas fa-filter"></i></button>
                <div class="excel-dropdown" onclick="event.stopPropagation();">
                    <div style="max-height: 250px; overflow-y: auto;">${listItems}</div>
                    <div class="excel-filter-actions">
                        <button type="button" class="btn-clear" onclick="applyCustomFilter('${paramName}', true)">Tozalash</button>
                        <button type="button" class="btn-apply" onclick="applyCustomFilter('${paramName}', false)">Qo'llash</button>
                    </div>
                </div>
            </div>`;
        const textDiv = targetTh.querySelector('.text');
        if (textDiv) {
            textDiv.style.display = 'inline-flex'; textDiv.style.alignItems = 'center';
            textDiv.insertAdjacentHTML('beforeend', html);
        } else { targetTh.insertAdjacentHTML('beforeend', html); }
    }

    createExcelFilter("guruh", "group_filter", groupOptions);
    createExcelFilter("ta'lim shakli", "education_form_filter", eduFormOptions);
    createExcelFilter("kurs", "course_filter", courseOptions);
    createExcelFilter("Foizi", "payment_percent", paymentOptions);
});

// --- GLOBAL ACTIONS ---
window.toggleExcelFilter = function(btn) {
    document.querySelectorAll('.excel-dropdown').forEach(d => { if (d !== btn.nextElementSibling) d.style.display = 'none'; });
    const menu = btn.nextElementSibling; menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
};
window.applyCustomFilter = function(paramName, clear) {
    const params = new URLSearchParams(window.location.search);
    if (clear) { params.delete(paramName); } else {
        const openDropdown = document.querySelector('.excel-dropdown[style*="block"]');
        if (openDropdown) {
            const checkedBoxes = openDropdown.querySelectorAll('input[type="checkbox"]:checked');
            const values = Array.from(checkedBoxes).map(cb => cb.value);
            if (values.length > 0) params.set(paramName, values.join(',')); else params.delete(paramName);
        }
    }
    window.location.search = params.toString();
};
window.addEventListener('click', function(e) { if (!e.target.closest('.excel-filter-wrapper')) { document.querySelectorAll('.excel-dropdown').forEach(d => d.style.display = 'none'); } });

// --- MODAL FUNKSIYALARI ---
function openExportModal() { document.getElementById('exportModal').style.display = 'flex'; }
function closeExportModal() { document.getElementById('exportModal').style.display = 'none'; }

function toggleAllCheckboxes() {
    const checkboxes = document.querySelectorAll('#exportForm input[type="checkbox"]');
    const allChecked = Array.from(checkboxes).every(c => c.checked);
    checkboxes.forEach(c => c.checked = !allChecked);
}

function submitExport() {
    const form = document.getElementById('exportForm');
    const urlParams = new URLSearchParams(window.location.search);
    const baseUrl = form.getAttribute('data-base-url');

    form.action = baseUrl + "?" + urlParams.toString();
    form.submit();
    closeExportModal();
}

window.onclick = function(e) { if (e.target == document.getElementById('exportModal')) closeExportModal(); }
</script>
{% endblock %}


{% block content %}
    {{ block.super }}

    <div id="exportModal" class="export-modal">
        <div class="export-modal-content">
            <div class="export-modal-header">
                <h3><i class="fas fa-file-excel" style="color: #107c41; margin-right: 12px;"></i> Ma'lumotlarni yuklash</h3>
                <span class="close-modal" onclick="closeExportModal()">&times;</span>
            </div>

            <form id="exportForm" method="POST" data-base-url="{% url 'admin:students_student_export' %}">
                {% csrf_token %}
                <div class="export-modal-body">

                    <div class="field-card">
                        <div class="field-card-title">
                            <i class="fas fa-user-circle"></i> Shaxsiy ma'lumotlar
                        </div>
                        <div class="checkbox-list">
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="student_hemis_id" checked> Talaba ID</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="full_name" checked> F.I.SH.</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="phone_number" checked> Telefon</label>

                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="passport_series_number"> Pasport Seriya</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="personal_pin"> PINFL (JSHSHIR)</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="date_of_birth"> Tug'ilgan sana</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="gender"> Jinsi</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="nationality"> Millati</label>
                        </div>
                    </div>

                    <div class="field-card">
                        <div class="field-card-title">
                            <i class="fas fa-graduation-cap"></i> O'qish ma'lumotlari
                        </div>
                        <div class="checkbox-list">
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="group" checked> Guruh</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="course_year" checked> Kurs</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="education_form" checked> Ta'lim shakli</label>

                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="education_type"> To'lov turi</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="status"> Status</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="current_semester"> Semestr</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="entry_score"> Kirish bali</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="document"> Hujjat holati</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="document_info"> Hujjat haqida</label>
                        </div>
                    </div>

                    <div class="field-card">
                        <div class="field-card-title">
                            <i class="fas fa-wallet"></i> Moliya va Qarzdorlik
                        </div>
                        <div class="checkbox-list">
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="current_contract_amount" checked> Kontrakt summasi</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="total_paid_amount" checked> To'langan summa</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="payment_percent" checked> To'lov foizi</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="payment_diff" checked> Asosiy qarz</label>

                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="subject_debt_total"> Fan qarzi (Jami)</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="subject_debt_paid"> Fan qarzi (To'langan)</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="subject_debt_diff"> Fan qarzi (Qoldiq)</label>

                            <label class="checkbox-item finance-stats-option">
                                <input type="checkbox" name="include_statistics" checked>
                                <i class="fas fa-chart-line" style="margin-right: 5px;"></i> Yakuniy statistikani qo'shish
                            </label>
                        </div>
                    </div>

                    <div class="field-card">
                        <div class="field-card-title">
                            <i class="fas fa-map-marked-alt"></i> Manzil va Hujjatlar
                        </div>
                        <div class="checkbox-list">
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="address"> Manzil</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="region"> Viloyat</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="district"> Tuman</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="citizenship"> Fuqarolik</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="passport_issued_by"> Pasport berilgan joy</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="previous_institution"> Oldingi o'qish joyi</label>
                        </div>
                    </div>

                </div>
                <div class="field-card">
                        <div class="field-card-title">
                            <i class="fas fa-map-marked-alt"></i> Manzil va Hujjatlar
                        </div>
                        <div class="checkbox-list">
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="address"> Manzil</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="region"> Viloyat</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="district"> Tuman</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="citizenship"> Fuqarolik</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="passport_issued_by"> Pasport berilgan joy</label>

                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="previous_institution"> Oldingi muassasa</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="document_type"> Hujjat turi</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="document_number"> Hujjat raqami</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="previous_graduation_year"> Bitirgan yili</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="certificate_info"> Sertifikat</label>
                            <label class="checkbox-item"><input type="checkbox" name="selected_fields" value="transferred_from_university"> Ko'chirgan OTM</label>
                        </div>
                    </div>

                <div class="export-modal-footer">
                    <button type="button" class="btn-outline" onclick="toggleAllCheckboxes()">Barchasini tanlash</button>
                    <button type="button" class="btn-primary-action" onclick="submitExport()">
                        <i class="fas fa-file-download"></i> Yuklash
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}